# email_reporter.py рдордзреАрд▓ рдорд╣рддреНрддреНрд╡рд╛рдЪреЗ рдмрджрд▓

import smtplib
from email.mime.text import MIMEText
import schedule
import time
import progress_tracker

# ЁЯМЯ рдпрд╛ рджреЛрди рдирд╡реАрди рдУрд│реА рдЯрд╛рдХ (рд╕рд┐рдХреНрд░реЗрдЯреНрд╕ рд╡рд╛рдЪрдгреНрдпрд╛рд╕рд╛рдареА)
import os
from dotenv import load_dotenv

# .env рдлрд╛рдИрд▓рдордзреВрди рд╕рд┐рдХреНрд░реЗрдЯреНрд╕ рд▓реЛрдб рдХрд░рд╛
load_dotenv()


def send_daily_report():
    print("тП│ рдИрдореЗрд▓ рдкрд╛рдард╡рдгреНрдпрд╛рдЪреА рддрдпрд╛рд░реА рдХрд░рдд рдЖрд╣реЗ...")

    # рез. рдбреЗрдЯрд╛рдмреЗрд╕рдордзреВрди рдирд┐рдХрд╛рд▓ рдЖрдгрдгреЗ
    correct, incorrect = progress_tracker.get_stats()
    total = correct + incorrect

    # реи. ЁЯМЯ рдЗрдереЗ рдЖрдкрдг рдЖрддрд╛ рд╣рд╛рддрд╛рдиреЗ рдкрд╛рд╕рд╡рд░реНрдб рд▓рд┐рд╣рд┐рдгрд╛рд░ рдирд╛рд╣реА! .env рдордзреВрди рдорд╛рдЧрд╡реВрдпрд╛:
    my_email = os.getenv("MY_EMAIL")
    app_password = os.getenv("EMAIL_PASSWORD")

    # рдЬрд░ .env рдлрд╛рдИрд▓рдордзреНрдпреЗ рдкрд╛рд╕рд╡рд░реНрдб рд╕рд╛рдкрдбрд▓рд╛ рдирд╛рд╣реА, рддрд░ рдПрд░рд░ рджрд╛рдЦрд╡рд╛
    if not my_email or not app_password:
        print("тЭМ рдПрд░рд░: .env рдлрд╛рдИрд▓рдордзреНрдпреЗ рдИрдореЗрд▓ рдХрд┐рдВрд╡рд╛ рдкрд╛рд╕рд╡рд░реНрдб рд╕рд╛рдкрдбрд▓рд╛ рдирд╛рд╣реА!")
        return


    # ... (рдЗрдереВрди рдкреБрдврдЪрд╛ рддреБрдЭрд╛ рдмреЙрдбреА рдЖрдгрд┐ рдИрдореЗрд▓ рдкрд╛рдард╡рдгреНрдпрд╛рдЪрд╛ рдмрд╛рдХреАрдЪрд╛ рд╕рдЧрд│рд╛ рдХреЛрдб рдЬрд╕рд╛рдЪреНрдпрд╛ рддрд╕рд╛ рд░рд╛рд╣реАрд▓) ...

    subject = "ЁЯУК рддреБрдЭрд╛ рдЖрдЬрдЪрд╛ English Study Report!"
    body = f"""
    рдирдорд╕реНрдХрд╛рд░ рдХреБрдгрд╛рд▓!

    рдЖрдЬрдЪрд╛ рддреБрдЭрд╛ рдЗрдВрдЧреНрд░рдЬреА рдЕрднреНрдпрд╛рд╕рд╛рдЪрд╛ рд░рд┐рдкреЛрд░реНрдЯ рдЦрд╛рд▓реАрд▓рдкреНрд░рдорд╛рдгреЗ рдЖрд╣реЗ:

    - рдПрдХреВрдг рддрдкрд╛рд╕рд▓реЗрд▓реА рд╡рд╛рдХреНрдпреЗ: {total}
    - рдмрд░реЛрдмрд░ рдЖрд▓реЗрд▓реА: {correct} тЬЕ
    - рдЪреБрдХрд▓реЗрд▓реА: {incorrect} тЭМ

    рдЕрд╕рд╛рдЪ рдЕрднреНрдпрд╛рд╕ рдЪрд╛рд▓реВ рдареЗрд╡! рдЙрджреНрдпрд╛ рдирд╡реАрди рд╡рд╛рдХреНрдпреЗ рд╢рд┐рдХреВрдпрд╛. ЁЯЪА

    - рддреБрдЭрд╛ Python AI Tutor
    """

    msg = MIMEText(body)
    msg['Subject'] = subject
    msg['From'] = my_email
    msg['To'] = my_email  # рд╕реНрд╡рддрдГрд▓рд╛рдЪ рдИрдореЗрд▓ рдкрд╛рдард╡рдд рдЖрд╣реЛрдд

    # рей. рдИрдореЗрд▓ рдкрд╛рдард╡рдгреЗ (SMTP Protocol - рд╣реЗрдЪ рддреЗ рдиреЗрдЯрд╡рд░реНрдХрд┐рдВрдЧ!)
    try:
        # Gmail рдЪреНрдпрд╛ рд╕рд░реНрд╡реНрд╣рд░рд▓рд╛ рдХрдиреЗрдХреНрдЯ рдХрд░рдгреЗ
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()  # рдХрдиреЗрдХреНрд╢рди рд╕реБрд░рдХреНрд╖рд┐рдд (Secure) рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА
        server.login(my_email, app_password)

        server.send_message(msg)
        server.quit()
        print("тЬЕ рд░рд╛рддреНрд░реА реп рд╡рд╛рдЬрд▓реЗ! рдИрдореЗрд▓ рдпрд╢рд╕реНрд╡реАрд░рд┐рддреНрдпрд╛ рдкрд╛рдард╡рд▓рд╛ рдЧреЗрд▓рд╛.")
    except Exception as e:
        print("тЭМ рдИрдореЗрд▓ рдкрд╛рдард╡рддрд╛рдирд╛ рдПрд░рд░ рдЖрд▓рд╛:", e)


# рек. рдЯрд╛рдпрдорд░ (Scheduler) рд▓рд╛рд╡рдгреЗ: рд░реЛрдЬ рд░рд╛рддреНрд░реА реп (21:00) рд╡рд╛рдЬрддрд╛
schedule.every().day.at("17:05").do(send_daily_report)

print("ЁЯдЦ рдИрдореЗрд▓ рдСрдЯреЛрдореЗрд╢рди рдЪрд╛рд▓реВ рдЭрд╛рд▓реЗ рдЖрд╣реЗ... (рд░рд╛рддреНрд░реА реп рд╡рд╛рдЬрдгреНрдпрд╛рдЪреА рд╡рд╛рдЯ рдмрдШрдд рдЖрд╣реЗ)")

# рд╣рд╛ рд▓реВрдк рдЪрд╛рд▓реВ рд░рд╛рд╣реАрд▓ рдЖрдгрд┐ рд╡реЗрд│реЗрдЪреА рд╡рд╛рдЯ рдмрдШреЗрд▓
while True:
    schedule.run_pending()
    time.sleep(60)  # рджрд░ рез рдорд┐рдирд┐рдЯрд╛рдиреЗ рдкрд╛рдпрдерди рдШрдбреНрдпрд╛рд│ рдЪреЗрдХ рдХрд░реЗрд▓